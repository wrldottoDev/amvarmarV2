{% extends "panel/base.html" %}
{% block content %}
<div class="container mt-4" style="max-width: 900px;">
  <h2>Crear Warehouse</h2>
  <form method="post" enctype="multipart/form-data" id="wh-form">
    {% csrf_token %}

    <div class="card mb-4">
      <div class="card-header fw-semibold">Datos del Warehouse</div>
      <div class="card-body">
        {{ form.non_field_errors }}
        <div class="row g-3">
          {% for field in form %}
            <div class="col-md-6">
              <label class="form-label">{{ field.label }}</label>
              {{ field }}
              {% if field.help_text %}<div class="form-text">{{ field.help_text }}</div>{% endif %}
              {% for e in field.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
        <span>Tipos de carga (Piezas)</span>
        <button class="btn btn-sm btn-outline-primary" type="button" id="add-piece">+ Agregar pieza</button>
      </div>
      <div class="card-body">
        {{ formset.non_field_errors }}
        {{ formset.management_form }}
        <div id="pieces-container" class="vstack gap-3">
          {% for f in formset %}
            <div class="border rounded p-3 piece-item">
              <div class="row g-3 align-items-end">
                <div class="col-md-4">
                  <label class="form-label">Tipo</label>
                  {{ f.type_of }}
                </div>
                <div class="col-md-3">
                  <label class="form-label">Cantidad</label>
                  {{ f.quantity }}
                </div>
                <div class="col-md-4">
                  <label class="form-label">Descripción</label>
                  {{ f.description }}
                </div>
                <div class="col-md-1">
                  {% if formset.can_delete %}
                    <label class="form-label d-block">Eliminar</label>
                    {{ f.DELETE }}
                  {% endif %}
                </div>
              </div>
              {% for e in f.errors.values %}
                <div class="text-danger small mt-2">{{ e|join:", " }}</div>
              {% endfor %}
            </div>
          {% endfor %}
        </div>

        <!-- empty form (oculto) para clonar -->
        <template id="empty-form-template">
          <div class="border rounded p-3 piece-item">
            <div class="row g-3 align-items-end">
              <div class="col-md-4">
                <label class="form-label">Tipo</label>
                __TYPE_OF__
              </div>
              <div class="col-md-3">
                <label class="form-label">Cantidad</label>
                __QUANTITY__
              </div>
              <div class="col-md-4">
                <label class="form-label">Descripción</label>
                __DESCRIPTION__
              </div>
              <div class="col-md-1">
                <label class="form-label d-block">Eliminar</label>
                __DELETE__
              </div>
            </div>
          </div>
        </template>

        <div id="empty-form-html" class="d-none">
          {{ formset.empty_form.as_p }}
        </div>
      </div>
    </div>

    <button class="btn btn-primary">Guardar</button>
    <a href="{% url 'admin_panel' %}" class="btn btn-outline-secondary ms-2">Cancelar</a>
  </form>
</div>

<script>
(function() {
  const addBtn = document.getElementById('add-piece');
  const container = document.getElementById('pieces-container');
  const totalForms = document.getElementById('id_pieces-TOTAL_FORMS');
  const tmpl = document.getElementById('empty-form-template').innerHTML.trim();
  const emptyHtml = document.getElementById('empty-form-html').innerHTML;

  function makeNewForm(index) {
    // Reemplaza ids y names en el empty_form
    let html = emptyHtml
      .replaceAll('__prefix__', index.toString())
      .replaceAll('name="pieces-__prefix__-type_of"', `name="pieces-${index}-type_of"`)
      .replaceAll('id="id_pieces-__prefix__-type_of"', `id="id_pieces-${index}-type_of"`)
      .replaceAll('name="pieces-__prefix__-quantity"', `name="pieces-${index}-quantity"`)
      .replaceAll('id="id_pieces-__prefix__-quantity"', `id="id_pieces-${index}-quantity"`)
      .replaceAll('name="pieces-__prefix__-description"', `name="pieces-${index}-description"`)
      .replaceAll('id="id_pieces-__prefix__-description"', `id="id_pieces-${index}-description"`)
      .replaceAll('name="pieces-__prefix__-DELETE"', `name="pieces-${index}-DELETE"`)
      .replaceAll('id="id_pieces-__prefix__-DELETE"', `id="id_pieces-${index}-DELETE"`);

    // Insertar los inputs en el layout bonito del template visible
    let wrapper = document.createElement('div');
    wrapper.innerHTML = tmpl;
    wrapper = wrapper.firstElementChild;

    wrapper.innerHTML = wrapper.innerHTML
      .replace('__TYPE_OF__', extractField(html, 'pieces-' + index + '-type_of'))
      .replace('__QUANTITY__', extractField(html, 'pieces-' + index + '-quantity'))
      .replace('__DESCRIPTION__', extractField(html, 'pieces-' + index + '-description'))
      .replace('__DELETE__', extractField(html, 'pieces-' + index + '-DELETE'));

    container.appendChild(wrapper);
  }

  function extractField(html, id) {
    const div = document.createElement('div');
    div.innerHTML = html;
    const el = div.querySelector('#id_' + id);
    // incluye label/input entorno inmediato
    return el ? el.outerHTML : '';
  }

  addBtn?.addEventListener('click', function() {
    const idx = parseInt(totalForms.value, 10);
    makeNewForm(idx);
    totalForms.value = idx + 1;
  });
})();
</script>
{% endblock %}
